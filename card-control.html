<link rel="import" href="../lunr-js/lunr-js.html">
<link rel="import" href="../fab-menu/fab-menu.html">
<link rel="import" href="../card-display/card-display.html">
<link rel="import" href="../card-data/card-data.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/image-icons.html">
<link rel="import" href="../iron-icons/social-icons.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--
`<card-control></card-control>` Let people 'add / share / edit / delete' cards
@demo demo.html
-->

<dom-module id="card-control">
  <template>
    <style is="custom-style">
      paper-toolbar div.container {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
      }
    </style>
    <card-data id="dealer" on-put="{{onPut}}" cards="{{cards}}" shared-cards="{{shared}}" url="{{url}}" uid="{{uid}}" token="{{token}}"></card-data>
    <template is="dom-if" if="{{!search}}">
      <card-display on-tapped="tapped" on-picked="picked" cards="{{cards}}" lookup="{{combined}}" pickable="{{pickable}}" selectable="{{selectable}}" selected="{{selected}}" sortable="{{sortable}}"></card-display>
      <template is="dom-if" if="{{!_mode}}">
        <template is="dom-if" if="{{!noPut}}">
          <fab-menu label="Add / Edit / Share / Delete" on-share="fabShare" on-delete="fabDelete" on-add="fabAdd" on-edit="fabEdit" icon="touch-app" back-label="Cancel" back-icon="subdirectory-arrow-left" menu="{{_menuFull}}"></fab-menu>
        </template>
        <template is="dom-if" if="{{noPut}}">
          <fab-menu label="Share" on-share="fabShare" icon="touch-app" back-label="Cancel" back-icon="subdirectory-arrow-left" menu="{{_menu}}"></fab-menu>
        </template>
      </template>
      <template is="dom-if" if="{{_mode}}">
        <paper-toolbar style="position:fixed;bottom:0;right:0;">
          <div class="container">
            <template is="dom-if" if="{{selected.length}}">
              <paper-button on-tap="doneIt" raised><iron-icon icon="done"></iron-icon>{{_mode}}</paper-button>
            </template>
            <paper-button raised on-tap="cancel"><iron-icon icon="cancel"></iron-icon>cancel</paper-button>
          </div>
        </paper-toolbar>
      </template>
    </template>
    <paper-dialog id="edit" modal>
      <paper-input label="Title" value="{{editing.title}}"></paper-input>
      <div class="buttons">
        <paper-button on-tap="saveEdit" dialog-confirm autofocus>Done</paper-button>
      </div>
    </paper-dialog>
    <template is="dom-if" if="{{search}}">
      <lunr-js data="{{searchaleCards}}" search="{{search}}" output="{{output}}"></lunr-js>
      <card-display cards="{{output}}"></card-display>
    </template>
  </template>
</dom-module>
<script>
Polymer({
  is: "card-control",
  properties: {
    url: {type: String},
    token: {type: String, value: ""},
    search: {type: String, value: ""},
    combined: {computed:"combine(cards, shared)"}, 
    _menuFull:{ 
      value: [
        {label:"Delete", icon:"delete", fire:{type:"delete"}},
        {label:"Edit", icon:"create", fire:{type:"edit"}},
        {label:"Share", icon:"social:share", fire:{type:"share"}},
        {label:"Add", icon:"add", menu:[
          {label:"Card", icon:"image:crop-portrait", fire:{type:"add", detail:"card"}},
          {label:"Deck", icon:"content-copy", fire:{type:"add", detail:"deck"}}
        ]}
      ],
      type: Array
    },
    _menu:{ 
      value: [
        {label:"Share", icon:"social:share", fire:{type:"share"}}
      ],
      type: Array
    },
    noPut: {value: false, type: Boolean},
    _select: {type: Array},
    _mode: {type: String, value: ""},
    searchaleCards: {type: Boolean, computed:"flaten(cards)"}
  },
  flaten: function(cards) {
    var list = {}
    var hasDeck = false
    var that = this
    cards.forEach(function(card) {
      if (card.url.startsWith("deck")) {
        hasDeck = true
        that.flaten(that.objectToArray(card.data)).forEach(function(card) {
          list[card.url] = card
        })
      } else {
        list[card.url] = card 
      }
    })
    if (hasDeck) {
      return this.flaten(this.objectToArray(list))
    } else {
      return this.objectToArray(list)
    }
  },
  objectToArray: function (data) {
    var output = []
    if (data) {
      var keys = Object.keys(data)
      for (var i = 0; i < keys.length; i++) {
        if (typeof data[keys[i]] === 'object') {
          output.push(data[keys[i]])
        }
      }
    }
    return output
  },
  fabDelete: function() {
    this._mode = "Delete"
    this.set("pickable", true)
  },
  fabAdd: function(e,detail) {
    if (detail === "deck") {
      this._mode = "Add to a Deck"
      this.set("selectable", true)
    }
    if (detail === "card") {
      //add 
    }
  },
  fabShare: function() {
    this._mode = "share"
    this.set("selectable", true)
  },
  fabEdit: function() {
    this._mode = "Pick the card to edit it"
    this.set("pickable", true)
  },
  picked: function(e,d) {
    if (this._mode === "Pick the card to edit it") {
      // edit 
      this.set("editing", this.cards[d])
      this.set("editingIndex", d) 
      this.$.edit.open()
      this._mode = ""
    }
    if (this._mode === "Delete") {
      this.splice("cards", d, 1)
      this._mode = ""
      this.set("pickable", false)
    }
    
  },
  saveEdit: function() {
    this.set("cards." +this.editingIndex, this.editing)
    this.set("cards", this.cards)
    this.set("pickable", false)
  },
  cancel: function() {
    this._mode = ""
    this.selected = []
    this.set("selectable", false)
    this.set("pickable", false)
  },
  doneIt: function() {
    if (this._mode === "Add to a Deck") {
      var newDesk = {title:"New Deck", data: {}, url: "deck"}
      for (var i = 0; i < this.selected.length; i++) {
        newDesk.data["00"+i] = this.cards[this.selected[i]]
      }
      this.set("cards", this.cards.concat([newDesk]))
    }

    this._mode = ""
    this.selected = []

    this.set("selectable", false)
    this.set("pickable", false)

  },
  tapped: function(a,details) {
    var card = details.card
    delete(details.card)
    if (card) {
      var trigger = "paper-button"
      var setMe = "hidden"
      var setTo = "true"
      
      if (card.hasOwnProperty("setMe")) {
        setMe = card.setMe
      }
      if (card.hasOwnProperty("setTo")) {
        setTo = card.setTo
      }
      if (card.hasOwnProperty("trigger")) {
        trigger = card.trigger
      }
      
      re = new RegExp(trigger, "i")
      var found = details.tag.match(re)
      if (found !== null) {
        var readableBy = {}
        readableBy[this.uid] = true
        
        if (card.hasOwnProperty("readableBy")) {
          for (var attr in card.readableBy) {
            readableBy[attr] = true
          }
        }
        card[setMe] = setTo
        this.$.dealer.deal({card: card, details: details, readableBy: readableBy})
      }
    }
  },
  combine: function(cards, shared) {
    allCards = this.flaten(cards)
    undup = {}
    for (var index in allCards) {
      if (allCards[index].url) {
        undup[allCards[index].url] = allCards[index]
      }
    }
    for (var index in shared) {
      
      if (undup[shared[index].card.url])
      if (undup[shared[index].card.url].hasOwnProperty("url"))
      if (shared[index].card.url === undup[shared[index].card.url].url) {
        undup[shared[index].card.url] = shared[index].card
      }
    }
    return undup
  }
})
</script>
