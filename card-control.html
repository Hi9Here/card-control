<link rel="import" href="../fab-menu/fab-menu.html">
<link rel="import" href="../card-display/card-display.html">
<link rel="import" href="../card-data/card-data.html">
<link rel="import" href="../icon-icons/iron-icons.html">
<link rel="import" href="../icon-icons/image-icons.html">
<link rel="import" href="../icon-icons/social-icons.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<!--
`<card-control></card-control>` Let people 'add / edit / delete' cards
@demo demo.html
-->

<dom-module id="card-control">
<template>
  <style is="custom-style">
  paper-toolbar div.container {
    @apply(--layout-horizontal);
    @apply(--layout-around-justified);
  }
</style>
  <card-data id="card" cards="{{cards}}" location="https://open-elements.firebaseio.com/all/" user-id="marcus6666" token="{{token}}"></card-data>
  <card-display on-picked="edit" cards="{{cards}}" pickable="{{pickable}}" selectable="{{selectable}}" selected="{{selected}}" sortable="{{sortable}}"></card-display>
  <template is="dom-if" if="{{!_mode}}">
    <fab-menu label="Add / Edit / Share / Delete" on-share="fabShare" on-delete="fabDelete" on-add="fabAdd" on-edit="fabEdit" icon="touch-app" back-label="Cancel" back-icon="subdirectory-arrow-left" menu="{{_menu}}"></fab-menu>
  </template>
  <template is="dom-if" if="{{_mode}}">
    <paper-toolbar style="position:fixed;bottom:0;left:0;right:0;">
      <div class="container">
        <template is="dom-if" if="{{selected.length}}">
          <paper-button on-tap="doneIt" raised><iron-icon icon="done"></iron-icon>{{_mode}}</paper-button>
        </template>
        <paper-button raised on-tap="cancel"><iron-icon icon="cancel"></iron-icon>cancel</paper-button>
      </div>
    </paper-toolbar>
  </template>
  <paper-dialog id="edit" modal>
    <paper-input label="Title" value="{{editing.title}}"></paper-input>
    <div class="buttons">
      <paper-button on-tap="saveEdit" dialog-confirm autofocus>Done</paper-button>
    </div>
  </paper-dialog>
</template>
</dom-module>
<script>
Polymer({
  is: "card-control",
  properties: {
    url: {type: String},
    token: {type: String},
    search: {type: String, value: ""},
    _menu:{ 
      value: [
        {label:"Delete",icon:"delete",fire:{type:"delete"}},
        {label:"Edit",icon:"create",fire:{type:"edit"}},
        {label:"Share",icon:"social:share",fire:{type:"share"}},
        {label:"Add","icon":"add","menu":[
          {label:"Card",icon:"image:crop-portrait",fire:{type:"add",detail:"card"}},
          {label:"Deck",icon:"content-copy",fire:{type:"add",detail:"deck"}}
        ]}
      ],
      type: Array
    },
    _select: {type: Array},
    _mode: {type: String, value: ""}
  },
  fabDelete: function() {
    this._mode = "Delete"
    this.set("selectable", true)
  },
  fabAdd: function(e,detail) {
    
    if (detail === "deck") {
      this._mode = "Add to a Deck"
      this.set("selectable", true)
    }
    if (detail === "card") {
      //add 
    }
  },
  fabShare: function() {
    this._mode = "share"
    this.set("selectable", true)
  },
  fabEdit: function() {
    this._mode = "Pick the card to edit it"
    this.set("pickable", true)
  },
  edit: function(e,d) {
    this._mode = ""
    // edit 
    this.set("editing", this.cards[d])
    this.set("editingIndex", d) 
    this.$.edit.open()
    
  },
  saveEdit: function() {
    this.set("cards." +this.editingIndex, this.editing)
    this.set("cards", this.cards)
    this.set("pickable", false)
  },
  cancel: function() {
    this._mode = ""
    this.selected = []
    this.set("selectable", false)
    this.set("pickable", false)
  },
  doneIt: function() {
    if (this._mode === "Add to a Deck") {
      var newDesk = {title:"New Deck", data: {}, url: "deck"}
      for (var i = 0; i < this.selected.length; i++) {
        newDesk.data["00"+i] = this.cards[this.selected[i]]
      }
      this.set("cards", this.cards.concat([newDesk]))
    } else if (this._mode === "Delete") {
      for (var i = 0; i < this.selected.length; i++) {
        this.cards[i] = {}
      }
    }

    this._mode = ""
    this.selected = []

    this.set("selectable", false)
    this.set("pickable", false)

  }
})
</script>
